<!DOCTYPE html>
<meta charset="utf-8">
<title>Election Dashboard</title>
<head>
  <link href="css/dc.css" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link href="css/styles.css" rel="stylesheet">
</head>
<body>
  <main class='container'>
    <h1>Crisis Net Nigerian Election Dashboard</h1>
    <div class='row'>
      <div class='col-md-8'>
        <h2> Published At </h2>
        <div class='col-md-6'>
          <div id='published-at-date-chart'>
            <span>Tweets by Published at Date </span>
            <a class='reset' href='javascript:publishedAtDateChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
          </div>
        </div>
        <div class='col-md-6'>
          <div id='published-at-hour-chart'>
            <span>Tweets by Published at by Time of Day</span>
            <a class='reset' href='javascript:publishedAtHourChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
          </div>
        </div>
      </div>
      <div class='col-md-4'>
        <h2> Hashtag Count</h2>
        <div id='hashtag-count-chart'>
          <span>Tweets by the number of Hashtags used</span>
          <a class='reset' href='javascript:hashtagCountChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>

    <div class='row'>
      <div class='col-md-8'>
        <h2> Updated At </h2>
        <div class='col-md-6'>
          <div id='updated-at-date-chart'>
            <span>Tweets by Updated at Date </span>
          <a class='reset' href='javascript:updatedAtDateChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
          </div>
        </div>
        <div class='col-md-6'>
          <div id='updated-at-hour-chart'>
            <span>Tweets by Updated at by Time of Day</span>
          <a class='reset' href='javascript:updatedAtHourChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
          </div>
        </div>
      </div>
      <div class='col-md-4'>
        <h2> @ Count</h2>
        <div id='at-count-chart'>
          <span>Tweets by the number of @ references used</span>
          <a class='reset' href='javascript:atCountChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
        </div>
      </div>
    </div>

    <div class='row'>
      <div class='col-md-8'>
        <h2> Author </h2>
        <div id='author-chart'>
          <span> Top 30 tweeters </span>
          <a class='reset' href='javascript:authorChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
        </div>
      </div>
      <div class='col-md-4'>
        <h2> Tweet Length</h2>
        <div id='tweet-length-chart'>
          <span> Length of Tweets </span>
          <a class='reset' href='javascript:tweetlengthChart.filterAll();dc.redrawAll();' style="display:none">reset</a>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>
    <div class='row'>
      <div class='col-md-12'>
        <h2> The Tweets</h2>
        <div class='overflow-table'>
          <span> Sorted by created date and limited to 500</span>
          <table id='data-table' class='table table-hover'>
            <thead>
              <tr>
                <th>Created</th>
                <th>Author</th>
                <th>Content</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </main>
  <script src="js/d3.js"></script>
  <script src="js/crossfilter.js"></script>
  <script src="js/dc.min.js"></script>
  <script src="js/queue.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="//cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>
  <script>
    var link = 'http://api.crisis.net/item?location=8.675277%2C9.081999&distance=200&tags=election&apikey=532d32c7ed3329652f114b70&limit=500'
    var publishedAtDateChart = dc.lineChart('#published-at-date-chart');
    var publishedAtHourChart = dc.barChart('#published-at-hour-chart');
    var updatedAtDateChart = dc.lineChart('#updated-at-date-chart');
    var updatedAtHourChart = dc.barChart('#updated-at-hour-chart');
    var authorChart = dc.barChart('#author-chart');
    var hashtagCountChart = dc.pieChart('#hashtag-count-chart');
    var atCountChart = dc.pieChart('#at-count-chart');
    var tweetlengthChart = dc.barChart('#tweet-length-chart');
    queue(3)
      .defer(d3.json, link)
      .defer(d3.json, link+'&offset=500')
      .defer(d3.json, link+'&offset=1000')
      .defer(d3.json, link+'&offset=1500')
      .defer(d3.json, link+'&offset=2000')
      .defer(d3.json, link+'&offset=2500')
      .defer(d3.json, link+'&offset=3000')
      .defer(d3.json, link+'&offset=3500')
      .defer(d3.json, link+'&offset=4000')
      .awaitAll(function(error, json){
        var data = json.reduce(function(memo, current) { return memo.concat(current.data)}, []);
        var margin = {top: 10, right: 50, bottom: 45, left: 40};

       data.forEach(function(datum) {
         datum.publishedAt = new Date(datum.publishedAt);
         datum.updatedAt = new Date(datum.updatedAt);
         datum.publishedDate = d3.time.day(datum.publishedAt);
         datum.updatedDate = d3.time.day(datum.updatedAt);
         datum.created = new Date(datum.createdAt).toDateString();
         datum.author = datum.author.username;
         datum.hashtag = datum.content.match(/#\w+/g) || [];
         datum.at = datum.content.match(/@\w+/g) || [];
         datum.tweetLength = datum.content.length;
       });

       var ndx = crossfilter(data);
       var all = ndx.groupAll();
       var today = new Date();

       var tweetLengthDimension = ndx.dimension(function(d) {
         if(d.tweetLength < 10){
           return '< 10';
         }else if( d.tweetLength <= 50) {
           return '10 - 50';
         }else if( d.tweetLength <= 100) {
           return '51 - 100';
         }else{
           return '> 100'
         }
       });
       var tweetLengthGroup = tweetLengthDimension.group().reduceCount();

       var publishedAtDateDimension = ndx.dimension(function(d) { return  d.publishedDate; });
       var publishedAtDateGroup = publishedAtDateDimension.group().reduceCount();

       var publishedAtHourDimension = ndx.dimension(function(d) { return  d.publishedAt.getHours(); });
       var publishedAtHourGroup = publishedAtHourDimension.group().reduceCount();

       var updatedAtDateDimension = ndx.dimension(function(d) { return  d.updatedDate; });
       var updatedAtDateGroup = updatedAtDateDimension.group().reduceCount();

       var updatedAtHourDimension = ndx.dimension(function(d) { return  d.updatedAt.getHours(); });
       var updatedAtHourGroup = updatedAtHourDimension.group().reduceCount();

       var authorDimension = ndx.dimension(function(d) { return d.author; });
       var authorGroup = authorDimension.group().reduceCount();

       var hashTagCountDimension = ndx.dimension(function(d) { return d.hashtag.length; });
       var hashtagCountGroup =  hashTagCountDimension.group().reduceCount();

       var atCountDimension = ndx.dimension(function(d) { return d.at.length; });
       var atCountGroup = atCountDimension.group().reduceCount();

       tweetlengthChart
        .width(350)
        .height(300)
        .margins({top: 20, bottom: 90, right: 20, left: 50})
        .dimension(tweetLengthDimension)
        .group(tweetLengthGroup)
        .x(d3.scale.ordinal())
        .xUnits(dc.units.ordinal)

      publishedAtHourChart
        .width(350)
        .height(200)
        .margins(margin)
        .dimension(publishedAtHourDimension)
        .group(publishedAtHourGroup)
        .elasticY(true)
        .centerBar(true)
        .round(dc.round.floor)
        .alwaysUseRounding(true)
        .x(d3.scale.linear().domain([0, 24]));

      publishedAtDateChart
        .width(350)
        .height(200)
        .margins(margin)
        .dimension(publishedAtDateDimension)
        .group(publishedAtDateGroup)
        .elasticY(true)
        .x(d3.time.scale().domain([today.setDate(today.getDate() - 4),  today.setDate(today.getDate() + 4)] ))
        .xUnits(d3.time.days)
        .renderlet(function(chart){
          chart.selectAll("g.x text")
            .attr('dx', '-27')
            .attr('dy', '-5')
            .attr('transform', "rotate(-60)");
        });

       updatedAtHourChart
        .width(350)
        .height(200)
        .margins(margin)
        .dimension(updatedAtHourDimension)
        .group(updatedAtHourGroup)
        .elasticY(true)
        .centerBar(true)
        .round(dc.round.floor)
        .alwaysUseRounding(true)
        .x(d3.scale.linear().domain([0, 24]));

      updatedAtDateChart
        .width(350)
        .height(200)
        .margins(margin)
        .dimension(updatedAtDateDimension)
        .group(updatedAtDateGroup)
        .elasticY(true)
        .x(d3.time.scale().domain([today.setDate(today.getDate() - 4),  today.setDate(today.getDate() + 4)] ))
        .xUnits(d3.time.days)
        .renderlet(function(chart){
          chart.selectAll("g.x text")
            .attr('dx', '-27')
            .attr('dy', '-5')
            .attr('transform', "rotate(-60)");
        });

      hashtagCountChart
        .width(200)
        .height(200)
        .dimension(hashTagCountDimension)
        .group(hashtagCountGroup)
        .innerRadius(40)
        .legend(dc.legend().x(240).y(0).gap(5));

     atCountChart
        .width(200)
        .height(200)
        .dimension(atCountDimension)
        .group(atCountGroup)
        .innerRadius(40)
        .legend(dc.legend().x(240).y(0).gap(5));

      var filteredAuthorGroup = filterAuthors(authorGroup)

      authorChart
        .width(760)
        .height(300)
        .margins({top: 20, bottom: 90, right: 20, left: 50})
        .dimension(authorDimension)
        .group(filteredAuthorGroup)
        .elasticY(true)
        .elasticX(true)
        .x(d3.scale.ordinal())
        .xUnits(dc.units.ordinal)
        .renderlet(function(chart){
          chart.selectAll("g.x text")
            .attr('dx', '-55')
            .attr('transform', "rotate(-60)");
        });


      dc.dataTable('#data-table')
        .dimension(updatedAtDateDimension)
        .group(function(d) {
          return d.publishedDate.toDateString();
        })
        .size(500)
        .columns([
          'created',
          'author',
          'content'
        ])

        dc.renderAll();
     });

     function filterAuthors(group) {
       return { all: function() { return group.top(30).filter(function(d) { return d.value > 1;});}}
     };
  </script>
</body>

